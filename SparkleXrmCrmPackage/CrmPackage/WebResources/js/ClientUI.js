// ClientUI.js
(function($){
Type.registerNamespace('ClientUI.Model');ClientUI.Model.Contact=function(){ClientUI.Model.Contact.initializeBase(this,['contact']);this._metaData['creditlimit']=Xrm.Sdk.AttributeTypes.money;}
ClientUI.Model.Contact.prototype={contactid:null,parentcustomerid:null,creditlimit:null,firstname:null,lastname:null,preferredcontactmethodcode:null}
Type.registerNamespace('ClientUI');ResourceStrings=function(){}
Type.registerNamespace('ClientUI.ViewModel');ClientUI.ViewModel.ContactViewModel=function(parentRecord){this.contacts=new SparkleXrm.GridEditor.EntityDataViewModel(15,ClientUI.Model.Contact,false);this.AllowAddNew=ko.observable(true);ClientUI.ViewModel.ContactViewModel.initializeBase(this);this.$1_0=parentRecord;var $0=new ClientUI.ViewModel.ObservableContact();this.contacts=new SparkleXrm.GridEditor.EntityDataViewModel(15,ClientUI.Model.Contact,false);$0.parentcustomerid(parentRecord);this.ContactEdit=ko.validatedObservable($0);this.ContactEdit().add_onSaveComplete(ss.Delegate.create(this,this.$1_4));this.ErrorMessage=ko.observable();this.contacts.onDataLoaded.subscribe(ss.Delegate.create(this,this.$1_2));ClientUI.ViewModel.ObservableContact.registerValidation(this.contacts.validationBinder);}
ClientUI.ViewModel.ContactViewModel.prototype={$1_0:null,$1_1:10,ErrorMessage:null,ContactEdit:null,$1_2:function($p0,$p1){var $0=$p1;for(var $1=0;$1<$0.to+1;$1++){var $2=this.contacts.getItem($1);Xrm.Utility.alertDialog(String.format('First Name is {0}, Last Name is {1}, Credit limit is {2}',$2.firstname,$2.lastname,$2.creditlimit),function(){
});if($2==null){return;}$2.add_propertyChanged(ss.Delegate.create(this,this.$1_3));}},$1_3:function($p0,$p1){var $0=$p0;Xrm.Utility.alertDialog(String.format('First Name is {0}, Last Name is {1}, Credit limit is {2}',$0.firstname,$0.lastname,$0.creditlimit),function(){
});Xrm.Sdk.OrganizationServiceProxy.beginUpdate($0,ss.Delegate.create(this,function($p1_0){
try{Xrm.Sdk.OrganizationServiceProxy.update($0);this.ErrorMessage('');}catch($1_0){this.ErrorMessage($1_0.message);}finally{}}));},$1_4:function($p0){if($p0==null){this.ErrorMessage(null);this.contacts.reset();this.contacts.refresh();}else{this.ErrorMessage($p0);}},search:function(){var $0=this.$1_0.id.toString().replaceAll('{','').replaceAll('}','');this.contacts.set_fetchXml("<fetch version='1.0' output-format='xml-platform' mapping='logical'  returntotalrecordcount='true' no-lock='true' distinct='false' count='{0}' paging-cookie='{1}' page='{2}'>\r\n                                            <entity name='contact'>\r\n                                            <attribute name='firstname' />\r\n                                            <attribute name='lastname' />\r\n                                            <attribute name='preferredcontactmethodcode' />\r\n                                            <attribute name='creditlimit' />                                            \r\n                                            <attribute name='contactid' />\r\n                                            <order attribute='fullname' descending='false' />\r\n                                            <filter type='and'>\r\n                                                <condition attribute='parentcustomerid' operator='eq' value='"+$0+"' />\r\n                                            </filter>                                            \r\n                                            {3}\r\n                                            </entity>\r\n                                        </fetch>");this.contacts.refresh();},AddNewCommand:function(){this.ContactEdit().AddNewVisible(true);}}
ClientUI.ViewModel.ObservableContact=function(){this.AddNewVisible=ko.observable(false);this.contactid=ko.observable();this.parentcustomerid=ko.observable();this.creditlimit=ko.observable();this.firstname=ko.observable();this.lastname=ko.observable();this.preferredcontactmethodcode=ko.observable();ClientUI.ViewModel.ObservableContact.initializeBase(this);ClientUI.ViewModel.ObservableContact.registerValidation(new SparkleXrm.ObservableValidationBinder(this));}
ClientUI.ViewModel.ObservableContact.validateCreditLimit=function(rules,viewModel,dataContext){return rules.addRequiredMsg(ResourceStrings.RequiredMessage);}
ClientUI.ViewModel.ObservableContact.validateLastName=function(rules,viewModel,dataContext){return rules.addRequiredMsg(ResourceStrings.RequiredMessage);}
ClientUI.ViewModel.ObservableContact.validatePreferredContactMethodCode=function(rules,viewModel,dataContext){return rules.addRule('Preferred Contact Method is required',function($p1_0){
return ($p1_0!=null)&&($p1_0).value!=null;});}
ClientUI.ViewModel.ObservableContact.registerValidation=function(binder){binder.register('lastname',ClientUI.ViewModel.ObservableContact.validateLastName);binder.register('creditlimit',ClientUI.ViewModel.ObservableContact.validateCreditLimit);binder.register('preferredcontactmethodcode',ClientUI.ViewModel.ObservableContact.validatePreferredContactMethodCode);}
ClientUI.ViewModel.ObservableContact.prototype={add_onSaveComplete:function(value){this.$1_0=ss.Delegate.combine(this.$1_0,value);},remove_onSaveComplete:function(value){this.$1_0=ss.Delegate.remove(this.$1_0,value);},$1_0:null,CancelCommand:function(){this.AddNewVisible(false);},SaveCommand:function(){var $0=(this).isValid();if(!$0){(this).errors.showAllMessages(true);return;}this.isBusy(true);var $1=new ClientUI.Model.Contact();$1.parentcustomerid=this.parentcustomerid();$1.creditlimit=this.creditlimit();$1.firstname=this.firstname();$1.lastname=this.lastname();$1.preferredcontactmethodcode=this.preferredcontactmethodcode();Xrm.Sdk.OrganizationServiceProxy.beginCreate($1,ss.Delegate.create(this,function($p1_0){
try{this.contactid(Xrm.Sdk.OrganizationServiceProxy.endCreate($p1_0));this.$1_0(null);(this).errors.showAllMessages(false);}catch($1_0){this.$1_0($1_0.message);}finally{this.isBusy(false);this.AddNewVisible(false);}}));},OpenAssociatedSubGridCommand:function(){var $0=window.parent.Xrm.Page.ui.navigation.items.get('navConnections');$0.setFocus();},contactSearchCommand:function(account,callback){var $0=String.format("<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>\r\n                                          <entity name='contact'>\r\n                                            <attribute name='fullname' />\r\n                                            <attribute name='telephone1' />\r\n                                            <attribute name='contactid' />\r\n                                            <order attribute='fullname' descending='false' />\r\n                                            <filter type='and'>\r\n                                              <condition attribute='parentcustomerid' operator='eq' uiname='A. Datum' uitype='account' value='{0}' />\r\n                                            </filter>\r\n                                          </entity>\r\n                                        </fetch>",Xrm.Sdk.Guid.empty);Xrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($0,function($p1_0){
var $1_0=Xrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,Xrm.Sdk.Entity);callback($1_0);});}}
Type.registerNamespace('ClientUI.View');ClientUI.View.ContactView=function(){}
ClientUI.View.ContactView.Init=function(){Xrm.PageEx.majorVersion=2013;var $0=new Xrm.Sdk.Guid(window.parent.Xrm.Page.data.entity.getId());var $1=window.parent.Xrm.Page.data.entity.getEntityName();ClientUI.View.ContactView.vm=new ClientUI.ViewModel.ContactViewModel(new Xrm.Sdk.EntityReference($0,$1,null));ClientUI.View.ContactView.currentUserSettings=Xrm.Sdk.OrganizationServiceProxy.getUserSettings();var $2=SparkleXrm.GridEditor.GridDataViewBinder.parseLayout(String.format('{0}, firstname, 250, {1}, lastname, 250, {2}, creditlimit, 250, {3}, preferredcontactmethodcode, 250',ResourceStrings.FirstName,ResourceStrings.LastName,ResourceStrings.CreditLimit,ResourceStrings.PreferredContactType));var $3=new SparkleXrm.GridEditor.GridDataViewBinder();SparkleXrm.GridEditor.GridDataViewBinder.addEditIndicatorColumn($2);SparkleXrm.GridEditor.XrmTextEditor.bindColumn($2[0]);SparkleXrm.GridEditor.XrmTextEditor.bindColumn($2[1]);SparkleXrm.GridEditor.XrmMoneyEditor.bindColumn($2[2],-1000,1000);SparkleXrm.GridEditor.XrmOptionSetEditor.bindColumn($2[3],'contact','preferredcontactmethodcode',false);ClientUI.View.ContactView.contactsGrid=$3.dataBindXrmGrid(ClientUI.View.ContactView.vm.contacts,$2,'container','pager',true,false);$3.addCheckBoxSelectColumn=false;$3.bindClickHandler(ClientUI.View.ContactView.contactsGrid);SparkleXrm.ViewBase.registerViewModel(ClientUI.View.ContactView.vm);$(window).resize(ClientUI.View.ContactView.$0);$(function(){
ClientUI.View.ContactView.vm.search();});var $4=Xrm.Sdk.OrganizationServiceProxy.getUserSettings().uilanguageid;}
ClientUI.View.ContactView.$0=function($p0){var $0=$(window).height();var $1=$(window).width();$('#container').height($0-64).width($1-1);ClientUI.View.ContactView.contactsGrid.resizeCanvas();}
ClientUI.Model.Contact.registerClass('ClientUI.Model.Contact',Xrm.Sdk.Entity);ResourceStrings.registerClass('ResourceStrings');ClientUI.ViewModel.ContactViewModel.registerClass('ClientUI.ViewModel.ContactViewModel',SparkleXrm.ViewModelBase);ClientUI.ViewModel.ObservableContact.registerClass('ClientUI.ViewModel.ObservableContact',SparkleXrm.ViewModelBase);ClientUI.View.ContactView.registerClass('ClientUI.View.ContactView');ResourceStrings.RequiredMessage='Required';ResourceStrings.SaveButton='Save';ResourceStrings.CancelButton='Cancel';ResourceStrings.Contacts='Contacts';ResourceStrings.FirstName='First Name';ResourceStrings.LastName='Last Name';ResourceStrings.CreditLimit='Credit Limit';ResourceStrings.PreferredContactType='Preferred Contact Method';ClientUI.View.ContactView.vm=null;ClientUI.View.ContactView.contactsGrid=null;ClientUI.View.ContactView.currentUserSettings=null;})(window.xrmjQuery);